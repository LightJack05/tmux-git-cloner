#!/usr/bin/bash
set -o pipefail

# tmux-git-cloner: Clone git repositories from configured remotes
# using fzf for selection and tmux for the clone process
#
# Uses gh CLI for GitHub and tea CLI for Gitea - no separate credential management needed

CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/tmux-git-cloner"
CONFIG_FILE="$CONFIG_DIR/config"

# Default values
CLONE_DIR="${HOME}/repos"
CLONE_PROTOCOL="ssh"  # ssh or https

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_error() {
    echo -e "${RED}Error: $1${NC}" >&2
}

log_info() {
    echo -e "${GREEN}$1${NC}" >&2
}

log_warn() {
    echo -e "${YELLOW}Warning: $1${NC}" >&2
}

# Check for required dependencies
check_dependencies() {
    local missing=()
    
    for cmd in fzf git tmux; do
        if ! command -v "$cmd" &> /dev/null; then
            missing+=("$cmd")
        fi
    done
    
    if [[ ${#missing[@]} -gt 0 ]]; then
        log_error "Missing required dependencies: ${missing[*]}"
        log_error "Please install them before running this script."
        exit 1
    fi
    
    # Check for at least one remote CLI
    if ! command -v gh &> /dev/null && ! command -v tea &> /dev/null; then
        log_error "At least one of 'gh' (GitHub CLI) or 'tea' (Gitea CLI) must be installed."
        log_error "Install gh: https://cli.github.com/"
        log_error "Install tea: https://gitea.com/gitea/tea"
        exit 1
    fi
}

# Create default config if it doesn't exist
create_default_config() {
    mkdir -p "$CONFIG_DIR"
    
    if [[ ! -f "$CONFIG_FILE" ]]; then
        cat > "$CONFIG_FILE" << 'EOF'
# tmux-git-cloner configuration file
# 
# CLONE_DIR: Directory where repositories will be cloned
# CLONE_PROTOCOL: Protocol to use for cloning (ssh or https)
#
# Remote configuration:
# This tool uses gh (GitHub CLI) and tea (Gitea CLI) for authentication.
# No tokens need to be configured here - use the respective CLI tools to authenticate:
#   - GitHub: gh auth login
#   - Gitea:  tea login add
#
# REMOTES: Space-separated list of remotes to query
# Format: type:host
# Examples:
#   github:github.com
#   github:github.mycompany.com  (GitHub Enterprise)
#   gitea:gitea.example.com

CLONE_DIR="${HOME}/repos"
CLONE_PROTOCOL="ssh"

# List of remotes to query (space-separated)
# Default includes github.com if gh is authenticated
REMOTES="github:github.com"

# Example with multiple remotes:
# REMOTES="github:github.com github:github.company.com gitea:git.mydomain.com"
EOF
        log_info "Created default config at $CONFIG_FILE"
        log_info "Please authenticate with your remotes:"
        log_info "  GitHub: gh auth login"
        log_info "  Gitea:  tea login add"
        exit 0
    fi
}

# Load configuration
load_config() {
    if [[ ! -f "$CONFIG_FILE" ]]; then
        create_default_config
    fi
    
    # Source the config file (only variable assignments)
    while IFS='=' read -r key value; do
        # Skip comments and empty lines
        [[ "$key" =~ ^[[:space:]]*# ]] && continue
        [[ -z "$key" ]] && continue
        
        # Remove leading/trailing whitespace
        key=$(echo "$key" | xargs)
        value=$(echo "$value" | xargs)
        
        # Remove quotes from value
        value="${value#\"}"
        value="${value%\"}"
        value="${value#\'}"
        value="${value%\'}"
        
        # Export the variable
        export "$key=$value"
    done < "$CONFIG_FILE"
    
    # Set defaults if not specified
    CLONE_DIR="${CLONE_DIR:-$HOME/repos}"
    CLONE_PROTOCOL="${CLONE_PROTOCOL:-ssh}"
    REMOTES="${REMOTES:-github:github.com}"
    
    # Create clone directory if it doesn't exist
    mkdir -p "$CLONE_DIR"
}

# Get the hostname for a gh remote (handles github.com specially)
get_gh_host_flag() {
    local host="$1"
    if [[ "$host" == "github.com" ]]; then
        echo ""
    else
        echo "--hostname $host"
    fi
}

# Fetch repositories from GitHub using gh CLI
fetch_github_repos() {
    local host="$1"
    
    if ! command -v gh &> /dev/null; then
        log_warn "gh CLI not installed, skipping GitHub remote '$host'"
        return
    fi
    
    # Check if authenticated
    local host_flag
    host_flag=$(get_gh_host_flag "$host")
    
    # shellcheck disable=SC2086
    if ! gh auth status $host_flag &> /dev/null; then
        log_warn "Not authenticated to GitHub ($host). Run: gh auth login $host_flag"
        return
    fi
    
    log_info "Fetching repositories from GitHub ($host)..." >&2
    
    # Fetch repos using gh CLI
    # shellcheck disable=SC2086
    gh repo list --limit 1000 --json nameWithOwner --jq '.[].nameWithOwner' $host_flag 2>/dev/null | \
        while IFS= read -r repo; do
            echo "$host/$repo"
        done
}

# Fetch repositories from Gitea using tea CLI
fetch_gitea_repos() {
    local host="$1"
    
    if ! command -v tea &> /dev/null; then
        log_warn "tea CLI not installed, skipping Gitea remote '$host'"
        return
    fi
    
    # Check if login exists for this host
    if ! tea login list 2>/dev/null | grep -q "$host"; then
        log_warn "No tea login found for '$host'. Run: tea login add --url https://$host"
        return
    fi
    
    log_info "Fetching repositories from Gitea ($host)..." >&2
    
    # Fetch repos using tea CLI
    tea repos list --login "$host" --output simple 2>/dev/null | \
        while IFS= read -r repo; do
            # tea outputs "owner/repo" format
            [[ -n "$repo" ]] && echo "$host/$repo"
        done
}

# Fetch all repositories from all configured remotes
fetch_all_repos() {
    local all_repos=()
    
    for remote in $REMOTES; do
        local type host
        type="${remote%%:*}"
        host="${remote#*:}"
        
        if [[ -z "$type" || -z "$host" ]]; then
            log_warn "Invalid remote format: '$remote' (expected type:host)"
            continue
        fi
        
        case "$type" in
            github)
                while IFS= read -r repo; do
                    [[ -n "$repo" ]] && all_repos+=("$repo")
                done < <(fetch_github_repos "$host")
                ;;
            gitea)
                while IFS= read -r repo; do
                    [[ -n "$repo" ]] && all_repos+=("$repo")
                done < <(fetch_gitea_repos "$host")
                ;;
            *)
                log_warn "Unknown remote type '$type' for host '$host'"
                ;;
        esac
    done
    
    printf '%s\n' "${all_repos[@]}" | sort -u
}

# Generate clone URL for a repository
get_clone_url() {
    local repo_path="$1"
    local host owner_repo
    
    host=$(echo "$repo_path" | cut -d'/' -f1)
    owner_repo=$(echo "$repo_path" | cut -d'/' -f2-)
    
    if [[ "$CLONE_PROTOCOL" == "ssh" ]]; then
        echo "git@${host}:${owner_repo}.git"
    else
        echo "https://${host}/${owner_repo}.git"
    fi
}

# Clone repository and create tmux session
clone_and_create_session() {
    local repo_path="$1"
    local clone_url target_dir session_name
    
    clone_url=$(get_clone_url "$repo_path")
    
    # Create target directory path: CLONE_DIR/host/owner/repo
    target_dir="$CLONE_DIR/$repo_path"
    
    # Generate session name from repo (replace invalid chars)
    session_name=$(echo "$repo_path" | tr '/' '_' | tr '.' '_')
    
    # Check if directory already exists
    if [[ -d "$target_dir" ]]; then
        log_info "Repository already exists at $target_dir"
        log_info "Creating tmux session..."
        
        if tmux has-session -t "$session_name" 2>/dev/null; then
            tmux switch-client -t "$session_name" 2>/dev/null || tmux attach-session -t "$session_name"
        else
            tmux new-session -d -s "$session_name" -c "$target_dir"
            tmux switch-client -t "$session_name" 2>/dev/null || tmux attach-session -t "$session_name"
        fi
        return
    fi
    
    # Create parent directory
    mkdir -p "$(dirname "$target_dir")"
    
    # Create tmux session and clone in it
    log_info "Cloning $repo_path..."
    log_info "URL: $clone_url"
    log_info "Target: $target_dir"
    
    # Create new tmux session
    if tmux has-session -t "$session_name" 2>/dev/null; then
        tmux kill-session -t "$session_name"
    fi
    
    # Write a temporary script for the clone process to avoid escaping issues
    local tmp_script
    tmp_script=$(mktemp)
    cat > "$tmp_script" << CLONE_SCRIPT
#!/usr/bin/bash
echo 'Cloning $repo_path...'
if git clone '$clone_url' '$target_dir'; then
    cd '$target_dir' || exit 1
    echo ''
    echo 'Clone complete! Press Enter to continue...'
    read -r
    exec \$SHELL
else
    echo ''
    echo 'Clone failed! Press Enter to exit...'
    read -r
fi
CLONE_SCRIPT
    chmod +x "$tmp_script"
    
    # Create session with clone script
    tmux new-session -d -s "$session_name" -c "$(dirname "$target_dir")" "$tmp_script; rm -f '$tmp_script'"
    
    # Switch to or attach to the session
    if [[ -n "$TMUX" ]]; then
        tmux switch-client -t "$session_name"
    else
        tmux attach-session -t "$session_name"
    fi
}

# Main function
main() {
    check_dependencies
    load_config
    
    log_info "Fetching repositories from configured remotes..."
    
    # Fetch all repos
    local repos
    repos=$(fetch_all_repos)
    
    if [[ -z "$repos" ]]; then
        log_error "No repositories found."
        log_error "Make sure you're authenticated to your remotes:"
        log_error "  GitHub: gh auth login"
        log_error "  Gitea:  tea login add"
        exit 1
    fi
    
    # Use fzf to select a repository
    local selected
    if [[ -n "$TMUX" ]]; then
        # Use tmux popup mode if available (tmux 3.2+)
        if tmux display-message -p '#{version}' | grep -qE '^3\.[2-9]|^[4-9]'; then
            # shellcheck disable=SC2016
            selected=$(echo "$repos" | fzf-tmux -p 80%,60% --prompt="Select repository: " \
                --preview='host=$(echo {} | cut -d/ -f1); path=$(echo {} | cut -d/ -f2-); echo "Clone URLs:"; echo "  SSH:   git@${host}:${path}.git"; echo "  HTTPS: https://${host}/${path}.git"' \
                --preview-window=down:4:wrap)
        else
            selected=$(echo "$repos" | fzf-tmux --prompt="Select repository: ")
        fi
    else
        selected=$(echo "$repos" | fzf --prompt="Select repository: ")
    fi
    
    if [[ -z "$selected" ]]; then
        log_info "No repository selected. Exiting."
        exit 0
    fi
    
    clone_and_create_session "$selected"
}

# Show help
show_help() {
    cat << EOF
tmux-git-cloner - Clone git repositories from configured remotes

Usage: tmux-git-cloner [OPTIONS]

Options:
    -h, --help      Show this help message
    -c, --config    Open configuration file in editor
    -l, --list      List all available repositories without cloning

Prerequisites:
    - gh CLI for GitHub (https://cli.github.com/)
    - tea CLI for Gitea (https://gitea.com/gitea/tea)
    
    Authenticate before use:
      GitHub: gh auth login
      Gitea:  tea login add

Configuration:
    Config file: $CONFIG_FILE
    
    The config file allows you to configure:
    - CLONE_DIR: Directory where repositories will be cloned
    - CLONE_PROTOCOL: Protocol to use (ssh or https)
    - REMOTES: List of remotes to query (format: type:host)

Examples:
    tmux-git-cloner              # Interactive repository selection
    tmux-git-cloner --list       # List all repositories
    tmux-git-cloner --config     # Edit configuration

EOF
}

# Parse command line arguments
case "${1:-}" in
    -h|--help)
        show_help
        exit 0
        ;;
    -c|--config)
        create_default_config
        "${EDITOR:-vim}" "$CONFIG_FILE"
        exit 0
        ;;
    -l|--list)
        check_dependencies
        load_config
        fetch_all_repos
        exit 0
        ;;
    "")
        main
        ;;
    *)
        log_error "Unknown option: $1"
        show_help
        exit 1
        ;;
esac
