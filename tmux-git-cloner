#!/usr/bin/bash
set -o pipefail

# tmux-git-cloner: Clone git repositories from configured remotes
# using fzf for selection and tmux for the clone process
#
# Uses gh CLI for GitHub and tea CLI for Gitea - no separate credential management needed

CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/tmux-git-cloner"
CONFIG_FILE="$CONFIG_DIR/config"

# Default values
CLONE_DIR="${HOME}/repos"

# Check for required dependencies
check_dependencies() {
    local missing=()
    
    for cmd in fzf git tmux; do
        if ! command -v "$cmd" &> /dev/null; then
            missing+=("$cmd")
        fi
    done
    
    if [[ ${#missing[@]} -gt 0 ]]; then
        echo "Error: Missing required dependencies: ${missing[*]}" >&2
        exit 1
    fi
    
    # Check for at least one remote CLI
    if ! command -v gh &> /dev/null && ! command -v tea &> /dev/null; then
        echo "Error: At least one of 'gh' (GitHub CLI) or 'tea' (Gitea CLI) must be installed." >&2
        exit 1
    fi
}

# Create default config if it doesn't exist
create_default_config() {
    mkdir -p "$CONFIG_DIR"
    
    if [[ ! -f "$CONFIG_FILE" ]]; then
        cat > "$CONFIG_FILE" << 'EOF'
# tmux-git-cloner configuration file
# 
# CLONE_DIR: Directory where repositories will be cloned
#
# Remote configuration:
# This tool uses gh (GitHub CLI) and tea (Gitea CLI) for authentication.
# No tokens need to be configured here - use the respective CLI tools to authenticate:
#   - GitHub: gh auth login
#   - Gitea:  tea login add
#
# REMOTES: Space-separated list of remotes to query
# Format: type:host:protocol
# Protocol can be 'ssh' or 'https'
# Examples:
#   github:github.com:ssh
#   github:github.mycompany.com:https  (GitHub Enterprise)
#   gitea:gitea.example.com:ssh

CLONE_DIR="${HOME}/repos"

# List of remotes to query (space-separated)
# Format: type:host:protocol
REMOTES="github:github.com:ssh"

# Example with multiple remotes:
# REMOTES="github:github.com:ssh github:github.company.com:https gitea:git.mydomain.com:ssh"
EOF
        exit 0
    fi
}

# Load configuration
load_config() {
    if [[ ! -f "$CONFIG_FILE" ]]; then
        create_default_config
    fi
    
    # Source the config file directly
    # shellcheck disable=SC1090
    source "$CONFIG_FILE"
    
    # Set defaults if not specified
    CLONE_DIR="${CLONE_DIR:-$HOME/repos}"
    REMOTES="${REMOTES:-github:github.com:ssh}"
    
    # Create clone directory if it doesn't exist
    mkdir -p "$CLONE_DIR"
}

# Get the hostname for a gh remote (handles github.com specially)
get_gh_host_flag() {
    local host="$1"
    if [[ "$host" == "github.com" ]]; then
        echo ""
    else
        echo "--hostname $host"
    fi
}

# Fetch repositories from GitHub using gh CLI
fetch_github_repos() {
    local host="$1"
    
    if ! command -v gh &> /dev/null; then
        return
    fi
    
    # Check if authenticated
    local host_flag
    host_flag=$(get_gh_host_flag "$host")
    
    # shellcheck disable=SC2086
    if ! gh auth status $host_flag &> /dev/null; then
        return
    fi
    
    # Fetch repos using gh CLI
    # shellcheck disable=SC2086
    gh repo list --limit 1000 --json nameWithOwner --jq '.[].nameWithOwner' $host_flag 2>/dev/null | \
        while IFS= read -r repo; do
            echo "$host/$repo"
        done
}

# Fetch repositories from Gitea using tea CLI
fetch_gitea_repos() {
    local host="$1"
    
    if ! command -v tea &> /dev/null; then
        return
    fi
    
    # Check if login exists for this host
    if ! tea login list 2>/dev/null | grep -q "$host"; then
        return
    fi
    
    # Fetch repos using tea CLI
    tea repos list --login "$host" --output simple 2>/dev/null | \
        while IFS= read -r repo; do
            # tea outputs "owner/repo" format
            [[ -n "$repo" ]] && echo "$host/$repo"
        done
}

# Fetch all repositories from all configured remotes
# Stores protocol info in REMOTE_PROTOCOLS associative array
declare -A REMOTE_PROTOCOLS

fetch_all_repos() {
    local all_repos=()
    
    for remote in $REMOTES; do
        local type host protocol
        # Parse format: type:host:protocol
        type="${remote%%:*}"
        local rest="${remote#*:}"
        host="${rest%%:*}"
        protocol="${rest#*:}"
        
        # Default protocol to ssh if not specified
        if [[ "$protocol" == "$host" ]]; then
            protocol="ssh"
        fi
        
        if [[ -z "$type" || -z "$host" ]]; then
            continue
        fi
        
        # Store protocol for this host
        REMOTE_PROTOCOLS["$host"]="$protocol"
        
        case "$type" in
            github)
                while IFS= read -r repo; do
                    [[ -n "$repo" ]] && all_repos+=("$repo")
                done < <(fetch_github_repos "$host")
                ;;
            gitea)
                while IFS= read -r repo; do
                    [[ -n "$repo" ]] && all_repos+=("$repo")
                done < <(fetch_gitea_repos "$host")
                ;;
        esac
    done
    
    printf '%s\n' "${all_repos[@]}" | sort -u
}

# Generate clone URL for a repository
get_clone_url() {
    local repo_path="$1"
    local host owner_repo protocol
    
    host=$(echo "$repo_path" | cut -d'/' -f1)
    owner_repo=$(echo "$repo_path" | cut -d'/' -f2-)
    protocol="${REMOTE_PROTOCOLS[$host]:-ssh}"
    
    if [[ "$protocol" == "ssh" ]]; then
        echo "git@${host}:${owner_repo}.git"
    else
        echo "https://${host}/${owner_repo}.git"
    fi
}

# Clone repository and create tmux session
clone_and_create_session() {
    local repo_path="$1"
    local clone_url target_dir session_name
    
    clone_url=$(get_clone_url "$repo_path")
    
    # Create target directory path: CLONE_DIR/host/owner/repo
    target_dir="$CLONE_DIR/$repo_path"
    
    # Use repo path as session name (/ is allowed in tmux session names)
    session_name="$repo_path"
    
    # Check if directory already exists
    if [[ -d "$target_dir" ]]; then
        if tmux has-session -t "$session_name" 2>/dev/null; then
            tmux switch-client -t "$session_name" 2>/dev/null || tmux attach-session -t "$session_name"
        else
            tmux new-session -d -s "$session_name" -c "$target_dir"
            tmux switch-client -t "$session_name" 2>/dev/null || tmux attach-session -t "$session_name"
        fi
        return
    fi
    
    # Create parent directory
    mkdir -p "$(dirname "$target_dir")"
    
    # Create new tmux session
    if tmux has-session -t "$session_name" 2>/dev/null; then
        tmux kill-session -t "$session_name"
    fi
    
    # Create session, run git clone, then drop into shell
    tmux new-session -d -s "$session_name" -c "$(dirname "$target_dir")" \
        "git clone '$clone_url' '$target_dir'; cd '$target_dir'; exec \$SHELL"
    
    # Switch to or attach to the session
    if [[ -n "$TMUX" ]]; then
        tmux switch-client -t "$session_name"
    else
        tmux attach-session -t "$session_name"
    fi
}

# Main function
main() {
    check_dependencies
    load_config
    
    # Fetch all repos
    local repos
    repos=$(fetch_all_repos)
    
    if [[ -z "$repos" ]]; then
        echo "Error: No repositories found." >&2
        exit 1
    fi
    
    # Use fzf to select a repository
    local selected
    if [[ -n "$TMUX" ]]; then
        # Use tmux popup mode if available (tmux 3.2+)
        if tmux display-message -p '#{version}' | grep -qE '^3\.[2-9]|^[4-9]'; then
            # shellcheck disable=SC2016
            selected=$(echo "$repos" | fzf-tmux -p 80%,60% --prompt="Select repository: " \
                --preview='host=$(echo {} | cut -d/ -f1); path=$(echo {} | cut -d/ -f2-); echo "Clone URLs:"; echo "  SSH:   git@${host}:${path}.git"; echo "  HTTPS: https://${host}/${path}.git"' \
                --preview-window=down:4:wrap)
        else
            selected=$(echo "$repos" | fzf-tmux --prompt="Select repository: ")
        fi
    else
        selected=$(echo "$repos" | fzf --prompt="Select repository: ")
    fi
    
    if [[ -z "$selected" ]]; then
        exit 0
    fi
    
    clone_and_create_session "$selected"
}

# Show help
show_help() {
    cat << EOF
tmux-git-cloner - Clone git repositories from configured remotes

Usage: tmux-git-cloner [OPTIONS]

Options:
    -h, --help      Show this help message
    -l, --list      List all available repositories without cloning

Prerequisites:
    - gh CLI for GitHub (https://cli.github.com/)
    - tea CLI for Gitea (https://gitea.com/gitea/tea)
    
    Authenticate before use:
      GitHub: gh auth login
      Gitea:  tea login add

Configuration:
    Config file: $CONFIG_FILE
    
    The config file allows you to configure:
    - CLONE_DIR: Directory where repositories will be cloned
    - REMOTES: List of remotes to query (format: type:host:protocol)

Examples:
    tmux-git-cloner              # Interactive repository selection
    tmux-git-cloner --list       # List all repositories

EOF
}

# Parse command line arguments
case "${1:-}" in
    -h|--help)
        show_help
        exit 0
        ;;
    -l|--list)
        check_dependencies
        load_config
        fetch_all_repos
        exit 0
        ;;
    "")
        main
        ;;
    *)
        echo "Error: Unknown option: $1" >&2
        show_help
        exit 1
        ;;
esac
